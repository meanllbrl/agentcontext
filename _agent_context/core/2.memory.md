---
name: active-memory
type: memory
updated: "2026-02-27"
---

## Active Memory


<!-- LIFO: newest entries at top -->

### 2026-02-27 - Neuroscience-Inspired Memory System (8 Phases)

Major redesign implementing the two-stage memory selection model from Joo & Frank 2025 (Science). Core innovation: separating waking-phase memory selection (bookmarking) from sleep-phase memory consolidation. Previously the sleep agent processed everything equally; now the agent tags important moments during active work and the sleep agent prioritizes those.

**Phase 1 - Bookmarks (Awake Ripples)**: `bookmark add/list/clear` commands. `Bookmark` type + `bookmarks[]` in `SleepState`. Stop hook links unlinked bookmarks to their session. Critical (salience 3) bookmarks trigger consolidation advisory regardless of debt level.

**Phase 2 - Knowledge Decay**: `knowledge touch <slug>` records access in `knowledge_access{}` map in `SleepState`. Snapshot shows staleness indicators for knowledge files not accessed in 30+ days.

**Phase 3 - Consolidation Rhythm**: `sessions_since_last_sleep` counter in `SleepState`. Rhythm advisory fires at 5+ sessions. Counter resets in `sleep done`.

**Phase 4 - Warm Knowledge Tier**: `extractFirstParagraph()` helper (handles YAML frontmatter). Warm knowledge section appears in snapshot between index and pinned. Warm = recently accessed (7-day window) OR tag-overlap with active tasks.

**Phase 5 - Contextual Triggers**: `trigger add/list/remove` commands. `Trigger` type + `triggers[]` in `SleepState`. Trigger matching in `generateSnapshot()` against task names, tags, bookmark text. `fired_count` persisted by `writeSleepState()` inside snapshot generation. Auto-expiry after `max_fires` hits, cleared in `sleep done`.

**Phase 6 - Transcript Distillation**: `transcript distill <session_id>` command. Pure Node.js structural JSONL filtering. Keeps: user messages, agent text (>20 chars), Write/Edit calls, modifying Bash, bookmark calls, errors. Discards: Read/Glob/Grep results, tool metadata, subagent internals.

**Phase 7 - Sleep History**: `SleepHistoryEntry` type, `sleep_history[]` (LIFO) in `SleepState`. `sleep history` subcommand. `sleep done` writes entry with debt_before/after, sessions and bookmarks processed. Snapshot shows last 3 entries.

**Phase 8 - System Flow Documentation**: Core file `_agent_context/core/6.system_flow.md` created with complete lifecycle, neuroscience mapping, data flows, SleepState schema, and salience levels.

**Cross-cutting fixes**: `freshDefaults()` replaces `DEFAULT_SLEEP_STATE` spread to prevent shared-reference mutation across test runs. Unnecessary `SleepState` casts removed from `change-tracker.ts` and `routes/sleep.ts`. 48 new tests added (384 total, 383 passing, 1 pre-existing flaky nanoid test). SKILL.md updated with bookmarking section and +9 commands. Rem-sleep agent updated with bookmark-first processing and transcript distillation.

New command files: `src/cli/commands/bookmark.ts`, `src/cli/commands/trigger.ts`, `src/cli/commands/transcript.ts`.

### 2026-02-27 - Notion-Style TaskDetailPanel Redesign

Redesigned `dashboard/src/components/tasks/TaskDetailPanel.tsx` from a rigid per-section layout to a Notion-style properties-block + markdown-body layout.

**Server**: Added `body: string` field to `TaskData` interface in `src/server/routes/tasks.ts`. Populated from `content` returned by `readFrontmatter()` (was already available but unused). All existing section fields kept for backward compat with CLI insert endpoints.

**Frontend**: Added `body: string` to `Task` interface in `dashboard/src/hooks/useTasks.ts`. Added `marked@^15` to `dashboard/package.json` for markdown-to-HTML rendering (~14KB gzipped, zero transitive deps).

**TaskDetailPanel**: Properties block (Notion-style bordered card, 140px label / 1fr value grid). Status and priority remain interactive dropdowns. Tags, feature, description, dates, and ID shown as property rows. Description uses ExpandableText (3-line clamp, requestAnimationFrame + scrollHeight > clientHeight detection). Full markdown body rendered below via `marked.parse()` + `dangerouslySetInnerHTML`. Changelog add form at bottom. Removed: TASK_SECTIONS array, per-section `<pre>` blocks, all "Add to X..." inputs, useInsertTaskSection import.

**CSS**: Panel widened from 520px to 680px. New `.props-block` / `.prop-row` classes. Comprehensive `.markdown-body` typography (h1-h6, lists, tables, code blocks, blockquotes, links, task checkboxes). Old section-specific classes removed.

Decision: `marked` over `react-markdown` — lighter (no transitive deps), HTML string output safe since content is local files only.

### 2026-02-27 - Tool Count Debt Scoring

Added `tool_count` field to `SessionRecord` to fix under-scoring of sessions that do significant work via read-only tools (Bash, Read, Glob, Grep) without any Write/Edit calls.

`scoreFromToolCount()` in `src/cli/commands/hook.ts`: 0 tools → 0, 1-15 → +1, 16-40 → +2, 41+ → +3. Final session score is `Math.max(scoreFromChangeCount, scoreFromToolCount)`. Stop hook records `tool_count` (all tool calls) alongside `change_count`. Snapshot display format updated: `(+2) 0 changes, 35 tools`. Dashboard types (`useSleep.ts`, `SleepPage.tsx`) updated to show `tool_count`. 8 new unit tests + 2 new integration tests added. 336 tests passing total.

### 2026-02-26 - SQL Parser Rewrite + SubagentStart Briefing Restructure

Rewrote `dashboard/src/lib/sql-parser.ts` from comma-split to line-by-line parsing. Fixes broken field extraction for multi-line CREATE TABLE statements. Added: REFERENCES detection for FK relationships, JSONB sub-field parsing from inline comments (e.g. `-- json: field_name: description`), `isSqlType()` validation helper.

Updated `dashboard/src/components/core/SqlPreview.tsx` and `SqlPreview.css`: collapsible JSONB field groups with toggle arrows and count badges, nested field display with left border and dot-notation names, new type color categories (number, json, timestamp).

Restructured `generateSubagentBriefing()` in `src/cli/commands/snapshot.ts`: hard directive ("BEFORE searching or exploring code, read `_agent_context/` files") moved to top of briefing, Features section promoted to position 3 with direct file Read paths for each feature, verbose system structure explanation replaced with compact 3-line Context Directory section at bottom. Problem solved: sub-agents were ignoring context and doing expensive codebase searches. 3 integration tests updated. 325 tests passing.

### 2026-02-26 - Enhanced Kanban Task Filters

Enhanced TaskFilters component with status filter dropdown, text search (name + description), and date range filter with field selector (created_at/updated_at). All filter state now persisted to localStorage via new `usePersistedState` hook (`dashboard/src/hooks/usePersistedState.ts`, prefix: `agentcontext:`). Clear Filters button shows active-count badge and resets filter fields only (preserves sortField and groupBy). `applyFilters()` in KanbanBoard.tsx handles all filter logic; `FilterState` interface exported from TaskFilters.tsx.

### 2026-02-26 - Dashboard UI Polish + selectedTask Bug Fix

Fixed stale snapshot bug in KanbanBoard: replaced `selectedTask: Task | null` state with `selectedSlug: string | null` + `useMemo` derivation from live query data. Detail panel now reflects post-mutation state without a manual refetch. 325 tests passing.

UI polish session: animated radial brand gradient on body (subtle-pulse 20s), stagger entrance animations for Kanban columns (`animate-stagger-N` classes, `slide-up-fade` with spring cubic-bezier), CSS refinements across all major components (Header, Sidebar, TaskCard, TaskCreateModal, TaskDetailPanel, CorePage, FeaturesPage, SleepPage, tokens). No structural changes.

### 2026-02-26 - Release Discovery System

Built `src/lib/release-discovery.ts`: auto-discovers unreleased tasks (status != completed or no released_version), features (released_version is null), and changelog entries (since last release date). `src/lib/release-backpopulate.ts` stamps `released_version` on features when bundled into a release.

CLI: `releases add --yes` (non-interactive, includes all unreleased), `releases list`, `releases show <version>`. Interactive `releases add` uses checkbox prompts. 3 new API routes added to server. Snapshot now shows Latest Release section; changelog limit dropped from 5 to 3 per request.

Release entry schema: `{ id, version, date, summary, breaking, features[], tasks[], changelog[] }`.

13 unit tests + 10 integration tests added; 325 total passing.

### 2026-02-26 - README + DEEP-DIVE Documentation Update

Updated README.md: Dashboard nav link, interactive mode mention in Quick Start, expanded Mermaid lifecycle diagram, full Dashboard section (usage, 2x2 feature table, design notes), releases commands (`add --yes`, `list`, `show`), Dashboard command subsection, auto-discovery explanation, "Web Dashboard" in Works With.

Updated DEEP-DIVE.md: features/ row in brain-region table, updated hook flow diagram with dashboard changes + latest release, full Dashboard section (change tracking, technical decisions, release management), 6 new Design Tradeoffs rows, "What Comes Next" reflects dashboard shipped.

### 2026-02-25 - SubagentStart Briefing Enrichment

Expanded SubagentStart hook briefing content. The briefing sub-agents receive now includes: system structure explanation (soul/user/memory/extended/features purpose), extended core files index, features listing (name, status, why, related tasks), knowledge index, and priority instructions ("Check feature PRDs first"). 4 new integration tests added; 301 tests passing.

### 2026-02-25 - SQL ER Diagram Preview (Dashboard)

Added visual ER diagram tab to `5.data_structures.sql` in the core file viewer.

New files: `dashboard/src/lib/sql-parser.ts` (parses CREATE TABLE and comment-based schema; extracts entities, fields with type inference, FK relationships), `dashboard/src/components/core/SqlPreview.tsx` (entity cards in CSS grid, SVG bezier curves with arrowheads for relationships), `dashboard/src/components/core/SqlPreview.css` (dot-grid background, storage type badges, color-coded field types, enum pills, PK/FK indicators).

Modified: `CorePage.tsx` now shows File/Preview tab toggle for SQL files, Preview is default. Tab bar uses segmented button design with brand gradient on active tab.

### 2026-02-25 - Change Tracker Field-Level Diffs

Enhanced `src/server/change-tracker.ts` with `FieldChange` interface (`from`/`to` values). `DashboardChange` now has an optional `fields` array. Net-change detection: A->B then B->A = cancelled (entry removed); A->B then B->C = folded to A->C. Append-only actions (changelog, insert) bypass detection.

Routes updated: `tasks.ts` reads old frontmatter before mutation, builds `FieldChange[]`; `knowledge.ts` captures old pinned value; `core.ts` detects frontmatter vs content changes; `sleep.ts` captures old debt value.

`FieldChange` interface synced between `src/server/change-tracker.ts`, `src/cli/commands/sleep.ts`, and `dashboard/src/hooks/useSleep.ts`. 19 new unit tests in `tests/unit/change-tracker.test.ts`.

### 2026-02-25 - Dashboard Error Handling & Loading States

Added comprehensive error handling across the dashboard (274 tests passing):
- `dashboard/src/api/client.ts`: `res.ok` check before `res.json()`, try/catch on error parsing
- `dashboard/src/App.tsx`: `ErrorBoundary` class component, query retry config (1 retry for queries, 0 for mutations)
- All 5 pages: `isError` check added
- `TaskDetailPanel.tsx`: mutation error feedback with auto-dismiss after 5s, `isPending` disables buttons
- `src/server/middleware.ts`: 1MB `MAX_BODY_SIZE` limit with `req.destroy()` on overflow
- `src/server/index.ts`: graceful shutdown on SIGINT/SIGTERM, 30s socket timeout, 5s force-exit
- `src/server/static.ts`: `Content-Type: text/plain` on 403/404 responses

### 2026-02-25 - Sleep Race Condition Fix + Tasks Non-Interactive

**Sleep race fix**: `sleep done` was unconditionally clearing all sessions and dashboard_changes, losing records from parallel sessions that finished during consolidation. Fixed with epoch-based filtering: `sleep_started_at` timestamp added to SleepState, new `sleep start` command records epoch, `sleep done` only clears records from before the epoch. Backward compatible when `sleep start` is not called.

**Tasks create non-interactive**: `tasks create` previously launched interactive prompts when `--description` or `--priority` were missing, blocking agent use. Fixed by using task name as default description and `medium` as default priority. Added `--status` flag (todo/in_progress/completed) and `--tags` flag. 279 tests passing.

### 2026-02-25 - Interactive Mode Highlight Fix

Fixed inquirer highlight styling bug where the full menu line was being colored instead of just the item name. Root cause: `style.highlight` in inquirer receives `'  ' + name` (cursor + space prefix), not just the name. Map key lookup was failing silently because keys stored only the name. Fix: `text.slice(2)` strips the 2-char cursor prefix before lookup, wraps result with `'  '` + `chalk.bgHex('#581C87')` background fill.

Result: unfocused items show dim border + category-colored label; focused items show bright magenta border + white bold label + purple `#581C87` background fill.

### 2026-02-25 - Web Dashboard (Phase 1-4)

Built `agentcontext dashboard` command: a local HTTP server serving a React SPA for visual context management.

**Server** (`src/server/`): Node.js native `http` module, zero new runtime deps. Router with `:param` extraction. Middleware for JSON parsing, CORS. Static file serving from `dist/dashboard/`. 17 REST API endpoints across 7 route files (tasks, sleep, core, knowledge, features, changelog, health). Change tracker records every mutating API call to `.sleep.json dashboard_changes`.

**React app** (`dashboard/`): React 19 + Vite 6, TypeScript strict. TanStack Query for server state. Pages: Kanban board (drag-drop, filter, sort, group), sleep state, core file editor, knowledge manager, features viewer. Design system: purple-magenta brand tokens (#641787, #781ca3, #8200a6, #db04b4), Visby CF font, 4px grid, HSL colors, light/dark mode, i18n-ready (English only, t() with translation keys).

**SleepState** extended: `dashboard_changes: DashboardChange[]` records entity/action/target/summary per manual user change. Cleared on `agentcontext sleep done`.

**Build**: `npm run build` = `build:dashboard` (Vite) + `build:cli` (tsup). tsup `onSuccess` copies `dashboard/dist/` to `dist/dashboard/`. Both ship in the npm package.

**Tests**: 325 passing (after subsequent sessions). Phase 5 remaining: accessibility audit, responsive polish, bundle size audit. Loading/error states completed (Phase 4).

Key decisions:
- React + Vite over Preact/Svelte for full ecosystem (TanStack Query, component patterns).
- Native HTML drag-and-drop over @dnd-kit. Upgrade if UX insufficient.
- No router library. State-based 5-page switcher. Add wouter later if URL routing needed.
- No CSS framework. Custom CSS with design tokens. Full control, minimal bundle.
- `dashboard/` is a separate package with its own `package.json`. Keeps React deps out of CLI deps.
- Agent character placeholder: brand diamond logo with opacity/animation tied to sleep level. Custom design coming later.

### 2026-02-25 - Foundation Implemented

Core CLI, all hooks (Stop/SessionStart/SubagentStart), sleep debt auto-tracking, snapshot, SubagentStart briefing with directive-at-top restructure, web dashboard (Phase 1-4), release discovery, FieldChange net-change tracking, SQL ER diagram preview, change tracker, error handling and loading states, UI polish animations. See earlier memory entries or git log for details.

## Technical Decisions

- **freshDefaults() prevents shared-reference mutation**: `DEFAULT_SLEEP_STATE` spread shared array references (bookmarks, triggers, etc.) across calls, causing test pollution. `freshDefaults()` in `sleep.ts` constructs a fresh object each time. Always use it when initializing an empty SleepState.
- **Bookmarks as primary consolidation signal**: Separating waking-phase memory selection (bookmarking) from sleep-phase consolidation is the key neuroscience insight. The sleep agent processes critical (salience 3) bookmarks first, then processes by change count. This mirrors the Joo & Frank 2025 hippocampal model.
- **Trigger fired_count persisted inside generateSnapshot()**: `writeSleepState()` is called within `generateSnapshot()` after matching triggers so fired counts survive without a separate persist step. Triggers expire in `sleep done`.
- **Transcript distillation is structural, not semantic**: Pure Node.js JSONL line filter. No AI call needed to reduce a 50K-line transcript to 200 high-signal lines. Tool name pattern matching is sufficient.
- **Warm knowledge uses 7-day window + tag overlap**: Two signals determine "warm": accessed in the last 7 days (from knowledge_access map) OR tag overlap with currently active tasks. First paragraph only (handles YAML frontmatter). Pinned knowledge remains separate (full content).
- **System flow lives in core/6, not knowledge/**: The lifecycle document is a core reference that the main agent should always be able to find from the snapshot. Knowledge files are for deep research on specific topics.
- **marked over react-markdown for task body rendering**: `marked@^15` is ~14KB gzipped with zero transitive deps. Safe to use `dangerouslySetInnerHTML` because content is local files only, never user-supplied remote content.
- **tool_count scoring uses Math.max over scoreFromChangeCount**: Bash-heavy sessions with no file writes previously scored 0. `scoreFromToolCount` (0/1-15/16-40/41+ → 0/1/2/3) provides a floor without double-counting work that involves both reads and writes.
- **selectedSlug over selectedTask in KanbanBoard**: Store slug string in state, derive Task via useMemo from live query. Prevents stale snapshots after mutations without additional refetch logic.
- **Release discovery is built-in, not deferred**: `releases add --yes` auto-discovers all unreleased items and back-populates features. The richer schema (features[], tasks[], changelog[]) shipped in the same session as discovery.
- **FieldChange net-change detection**: Change tracker folds A->B->C into A->C and cancels A->B->A. Append-only actions and entries without a `fields` array bypass detection.
- **SQL ER diagram uses SVG bezier curves, not a graph library**: D3/React Flow overkill. SVG paths with cubic bezier + arrowheads over CSS grid entity layout.
- **sql-parser.ts uses line-by-line parsing, not comma-split**: Comma-split breaks on multi-line column definitions and inline comments. Line-by-line tracks context (inside table, current field) and handles REFERENCES, JSONB comment annotations, and isSqlType validation without regex soup.
- **SubagentStart hook outputs JSON, SessionStart outputs plain text**: Driven by Claude Code's hook specs, not a design choice. Do not conflate these formats.
- **SubagentStart briefing is lighter than snapshot**: Sub-agents are task-focused and short-lived. Excludes soul/user/memory to avoid leaking internal agent rules. Directive ("BEFORE searching code, read _agent_context/ files") placed at the very top; features section at position 3 with direct Read paths. Bottom-loading context was being ignored by sub-agents.
- **Stop hook is synchronous**: Uses `readFileSync(0, 'utf-8')`. Guarantees .sleep.json is written before the next SessionStart hook fires. Async would create a race condition.
- **Sleep epoch-based clearing**: `sleep start` records a timestamp; `sleep done` only clears records from before the epoch. Post-epoch records survive for the next consolidation cycle.
- **Snapshot: no token budget, no truncation**: More tokens beats forgetting. If context grows too large, fix with better organization (pinning, knowledge extraction), not truncation.
- **ESM-only, no bundled deps**: chalk v5+ and nanoid v5+ are ESM-only. tsup externalizes all runtime deps to avoid ESM/CJS dual-package hazards.
- **Keyword search, not semantic**: `src/lib/search.ts` tokenize + substring match with score weighting. Zero dependencies, adequate for the use case.
- **LIFO default in insertToJsonArray**: `position: 'top'` is the default. CHANGELOG.json and task changelogs depend on this — do not change without auditing all callers.
- **Snapshot is chalk-free**: Consumed by the SessionStart shell hook. ANSI codes break shell hook processing.

## Known Issues

- **1 pre-existing flaky test**: `tests/unit/id.test.ts` (`generates 8-char suffix after prefix`, nanoid(8) intermittently returns 5 chars). 383 of 384 tests pass otherwise. Fix nanoid usage or mock before next publish.
- Integration tests require a manual `npm run build` before they can run against `dist/index.js`. `npm run build` builds dashboard first, then CLI.
- `getTemplateDir()` in `init.ts` uses a candidate-path approach. Unusual pnpm node_modules layouts could cause silent template resolution failure and produce placeholder stubs.
- The interactive mode (readline REPL) creates a fresh Commander program for every command. Slightly wasteful but not a problem at current scale.
- **Dashboard Phase 5 pending**: Accessibility audit, responsive layout (sidebar collapse), i18n token extraction from hardcoded strings, bundle size audit (~80KB gzipped, acceptable).
