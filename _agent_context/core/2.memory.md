---
name: active-memory
type: memory
updated: "2026-02-25"
---

## Active Memory


<!-- LIFO: newest entries at top -->

### 2026-02-25 - SubagentStart Briefing Enrichment

Expanded SubagentStart hook briefing content. The briefing sub-agents receive now includes: system structure explanation (soul/user/memory/extended/features purpose), extended core files index, features listing (name, status, why, related tasks), knowledge index, and priority instructions ("Check feature PRDs first"). 4 new integration tests added; 301 tests passing.

### 2026-02-25 - SQL ER Diagram Preview (Dashboard)

Added visual ER diagram tab to `5.data_structures.sql` in the core file viewer.

New files: `dashboard/src/lib/sql-parser.ts` (parses CREATE TABLE and comment-based schema; extracts entities, fields with type inference, FK relationships), `dashboard/src/components/core/SqlPreview.tsx` (entity cards in CSS grid, SVG bezier curves with arrowheads for relationships), `dashboard/src/components/core/SqlPreview.css` (dot-grid background, storage type badges, color-coded field types, enum pills, PK/FK indicators).

Modified: `CorePage.tsx` now shows File/Preview tab toggle for SQL files, Preview is default. Tab bar uses segmented button design with brand gradient on active tab.

### 2026-02-25 - Change Tracker Field-Level Diffs

Enhanced `src/server/change-tracker.ts` with `FieldChange` interface (`from`/`to` values). `DashboardChange` now has an optional `fields` array. Net-change detection: A->B then B->A = cancelled (entry removed); A->B then B->C = folded to A->C. Append-only actions (changelog, insert) bypass detection.

Routes updated: `tasks.ts` reads old frontmatter before mutation, builds `FieldChange[]`; `knowledge.ts` captures old pinned value; `core.ts` detects frontmatter vs content changes; `sleep.ts` captures old debt value.

`FieldChange` interface synced between `src/server/change-tracker.ts`, `src/cli/commands/sleep.ts`, and `dashboard/src/hooks/useSleep.ts`. 19 new unit tests in `tests/unit/change-tracker.test.ts`.

### 2026-02-25 - Release Backpopulation (Deferred)

Discussed rich release entries with auto-discovery (tasks done, features without released_version, changelog range). Decision: current barebones approach is fine for v0.1.0. The richer `core releases add` workflow with back-population of features is a post-v0.1.0 enhancement. No code changes made.

### 2026-02-25 - Dashboard Error Handling & Loading States

Added comprehensive error handling across the dashboard (274 tests passing):
- `dashboard/src/api/client.ts`: `res.ok` check before `res.json()`, try/catch on error parsing
- `dashboard/src/App.tsx`: `ErrorBoundary` class component, query retry config (1 retry for queries, 0 for mutations)
- All 5 pages: `isError` check added
- `TaskDetailPanel.tsx`: mutation error feedback with auto-dismiss after 5s, `isPending` disables buttons
- `src/server/middleware.ts`: 1MB `MAX_BODY_SIZE` limit with `req.destroy()` on overflow
- `src/server/index.ts`: graceful shutdown on SIGINT/SIGTERM, 30s socket timeout, 5s force-exit
- `src/server/static.ts`: `Content-Type: text/plain` on 403/404 responses

### 2026-02-25 - Sleep Race Condition Fix + Tasks Non-Interactive

**Sleep race fix**: `sleep done` was unconditionally clearing all sessions and dashboard_changes, losing records from parallel sessions that finished during consolidation. Fixed with epoch-based filtering: `sleep_started_at` timestamp added to SleepState, new `sleep start` command records epoch, `sleep done` only clears records from before the epoch. Backward compatible when `sleep start` is not called.

**Tasks create non-interactive**: `tasks create` previously launched interactive prompts when `--description` or `--priority` were missing, blocking agent use. Fixed by using task name as default description and `medium` as default priority. Added `--status` flag (todo/in_progress/completed) and `--tags` flag. 279 tests passing.

### 2026-02-25 - Interactive Mode Highlight Fix

Fixed inquirer highlight styling bug where the full menu line was being colored instead of just the item name. Root cause: `style.highlight` in inquirer receives `'  ' + name` (cursor + space prefix), not just the name. Map key lookup was failing silently because keys stored only the name. Fix: `text.slice(2)` strips the 2-char cursor prefix before lookup, wraps result with `'  '` + `chalk.bgHex('#581C87')` background fill.

Result: unfocused items show dim border + category-colored label; focused items show bright magenta border + white bold label + purple `#581C87` background fill.

### 2026-02-25 - Web Dashboard (Phase 1-4)

Built `agentcontext dashboard` command: a local HTTP server serving a React SPA for visual context management.

**Server** (`src/server/`): Node.js native `http` module, zero new runtime deps. Router with `:param` extraction. Middleware for JSON parsing, CORS. Static file serving from `dist/dashboard/`. 17 REST API endpoints across 7 route files (tasks, sleep, core, knowledge, features, changelog, health). Change tracker records every mutating API call to `.sleep.json dashboard_changes`.

**React app** (`dashboard/`): React 19 + Vite 6, TypeScript strict. TanStack Query for server state. Pages: Kanban board (drag-drop, filter, sort, group), sleep state, core file editor, knowledge manager, features viewer. Design system: purple-magenta brand tokens (#641787, #781ca3, #8200a6, #db04b4), Visby CF font, 4px grid, HSL colors, light/dark mode, i18n-ready (English only, t() with translation keys).

**SleepState** extended: `dashboard_changes: DashboardChange[]` records entity/action/target/summary per manual user change. Cleared on `agentcontext sleep done`.

**Build**: `npm run build` = `build:dashboard` (Vite) + `build:cli` (tsup). tsup `onSuccess` copies `dashboard/dist/` to `dist/dashboard/`. Both ship in the npm package.

**Tests**: 313 passing. Phase 5 remaining: accessibility audit, responsive polish, bundle size audit. Loading/error states completed (Phase 4).

Key decisions:
- React + Vite over Preact/Svelte for full ecosystem (TanStack Query, component patterns).
- Native HTML drag-and-drop over @dnd-kit. Upgrade if UX insufficient.
- No router library. State-based 5-page switcher. Add wouter later if URL routing needed.
- No CSS framework. Custom CSS with design tokens. Full control, minimal bundle.
- `dashboard/` is a separate package with its own `package.json`. Keeps React deps out of CLI deps.
- Agent character placeholder: brand diamond logo with opacity/animation tied to sleep level. Custom design coming later.

### 2026-02-25 - SubagentStart Hook Support

Added SubagentStart hook so sub-agents receive lightweight context on launch without any agent tool calls.

Key changes:
- `src/cli/commands/snapshot.ts`: Added `generateSubagentBriefing()` (~25 line output). Extracted `getActiveTaskLines()` helper shared with `generateSnapshot()`.
- `src/cli/commands/hook.ts`: Added `hook subagent-start` subcommand outputting JSON `{"hookSpecificOutput":{"hookEventName":"SubagentStart","additionalContext":"..."}}`.
- `src/cli/commands/install-skill.ts`: Registers SubagentStart hook in `.claude/settings.json` (no matcher, 5s timeout).
- `skill/SKILL.md`: SubagentStart hook in frontmatter, context propagation note, command reference entry.
- `src/cli/index.ts`, `README.md`: Updated references (three hooks, updated settings.json description).
- 10 new integration tests in `tests/integration/hook.test.ts`; 246 total passing.

Key decisions:
- SubagentStart over CLAUDE.md injection (invasive, static), custom agent overrides (too invasive), or skills preloading (only custom agents). SubagentStart is universal, dynamic, non-invasive.
- No matcher: fires for ALL sub-agents including agentcontext-initializer and agentcontext-rem-sleep. Extra context does not conflict with their own prompts.
- Briefing is lighter than full snapshot: includes project summary (120 char cap), directory structure, active tasks, knowledge index, pinned knowledge, usage instructions. Excludes soul/user/memory content, sleep state, changelog, features detail.
- JSON output format is required by Claude Code's SubagentStart spec. Different from SessionStart which uses plain text.

### 2026-02-25 - Code Registry Removal

Removed the `coderegistry` command entirely. Decision: code registries go stale immediately when methods are renamed, moved, or deleted. Manual maintenance cannot keep up. The agent's native tools (Grep, Glob) serve component discovery better than a static registry.

Scope of removal:
- Deleted `src/cli/commands/coderegistry.ts` and `src/templates/init/6.code_registry.json`
- Removed all references from `src/cli/index.ts`, `src/cli/interactive.ts`, `src/cli/commands/init.ts`
- Updated tests: replaced code_registry fixture in `core-index.test.ts`, removed coderegistry integration test from `cli-commands.test.ts`
- Updated distributed docs: `skill/SKILL.md`, `agents/agentcontext-rem-sleep.md`, `agents/agentcontext-initializer.md`, `README.md`
- Updated context files: removed code-registry feature PRD, removed `6.code_registry.json` data file

Result: 9 commands (was 10), 246 tests all passing. The numbering gap at slot 6 is intentional — left available for user customization. The three current extended files (style_guide, tech_stack, data_structures) cover the essential ground.

### 2026-02-25 - Features Snapshot Enhancement + System Reassessment

Re-evaluated the 9-issue critical assessment from complete_plan.md. Outcome:

- All 5 originally identified functional gaps are confirmed resolved (persistent sleep, smart snapshot, CLI trim, knowledge visibility, sleep debt surfacing).
- Features subsystem: confirmed as core to solo developer workflow. Feature PRDs give the agent complete context (user stories, acceptance criteria, constraints) without Jira/Linear. Not scope creep.
- SKILL.md: ~510 lines. Token cost accepted as worthwhile trade-off. Trimming to 200 lines goal dropped.
- 1 pre-existing flaky test in `tests/unit/id.test.ts` (`generates 8-char suffix after prefix`) where nanoid(8) sometimes returns 5 chars. Not related to current changes. 225 tests pass.

**Features snapshot improvement** (`src/cli/commands/snapshot.ts`, section 8):
- **Why**: reads `## Why` markdown section via `readSection`, shows first non-empty non-placeholder line (capped at 120 chars).
- **Tasks**: shows `related_tasks` from frontmatter.
- **Latest**: reads `## Changelog` section, shows most recent non-creation entry (header + first bullet, capped at 120 chars).
- Uses existing `readSection` from `src/lib/markdown.ts` — no new lib files needed.
- 2 integration tests added (rich feature + minimal feature); both passing.

### 2026-02-25 - Hook-Based Sleep Debt Auto-Tracking + Smart Snapshot + Sleep State

- `hook stop` / `hook session-start` implemented. Stop hook records session to .sleep.json (synchronous stdin read). SessionStart analyzes previous transcript (regex for Write/Edit tool calls), auto-scores debt (1-3=+1, 4-8=+2, 9+=+3), injects graduated consolidation directives, then outputs snapshot. `install-skill` migrates existing hooks.
- Smart Snapshot: extended core files index (`core-index.ts`), knowledge index (`knowledge-index.ts`), pinned knowledge (full content loaded for `pinned: true` files). `knowledge index` and `knowledge tags` commands added.
- Persistent sleep state: `sleep status/add/done/debt` in `state/.sleep.json`.
- CLI stripped: removed list/read/search/update subcommands (was 203 tests, now 162 after strip).
- README rewritten: token-burning search spiral framing, Mermaid lifecycle diagram, brain-region analogy table, no em dashes. PRD.md deleted; key content preserved in `knowledge/project-origin-and-prd.md`.

### 2026-02-24 - Context Populated
Full codebase scan. All commands implemented, unit and integration tests written. SKILL.md, initializer agent, and rem-sleep agent complete and shipping with package.

## Technical Decisions

- **Release backpopulation deferred to post-v0.1.0**: Current `RELEASES.json` is barebones (version, date, summary, changes, breaking). Richer entries with auto-discovery and feature back-population are designed but not blocking v0.1.0.
- **FieldChange net-change detection**: Change tracker folds A->B->C into A->C and cancels A->B->A. Append-only actions and entries without a `fields` array bypass detection.
- **SQL ER diagram uses SVG bezier curves, not a graph library**: D3/React Flow overkill. SVG paths with cubic bezier + arrowheads over CSS grid entity layout.
- **SubagentStart hook outputs JSON, SessionStart outputs plain text**: Driven by Claude Code's hook specs, not a design choice. Do not conflate these formats.
- **SubagentStart briefing is lighter than snapshot**: Sub-agents are task-focused and short-lived. Excludes soul/user/memory to avoid leaking internal agent rules.
- **Stop hook is synchronous**: Uses `readFileSync(0, 'utf-8')`. Guarantees .sleep.json is written before the next SessionStart hook fires. Async would create a race condition.
- **Sleep epoch-based clearing**: `sleep start` records a timestamp; `sleep done` only clears records from before the epoch. Post-epoch records survive for the next consolidation cycle.
- **Snapshot: no token budget, no truncation**: More tokens beats forgetting. If context grows too large, fix with better organization (pinning, knowledge extraction), not truncation.
- **ESM-only, no bundled deps**: chalk v5+ and nanoid v5+ are ESM-only. tsup externalizes all runtime deps to avoid ESM/CJS dual-package hazards.
- **Keyword search, not semantic**: `src/lib/search.ts` tokenize + substring match with score weighting. Zero dependencies, adequate for the use case.
- **LIFO default in insertToJsonArray**: `position: 'top'` is the default. CHANGELOG.json and task changelogs depend on this — do not change without auditing all callers.
- **Snapshot is chalk-free**: Consumed by the SessionStart shell hook. ANSI codes break shell hook processing.

## Known Issues

- **2 pre-existing flaky tests**: `tests/unit/id.test.ts` (`generates 8-char suffix after prefix`, nanoid(8) intermittently returns 5 chars) and a snapshot changelog integration test. 313 tests pass otherwise. Fix nanoid usage or mock before v0.1.0 publish.
- Integration tests require a manual `npm run build` before they can run against `dist/index.js`. `npm run build` builds dashboard first, then CLI.
- `getTemplateDir()` in `init.ts` uses a candidate-path approach. Unusual pnpm node_modules layouts could cause silent template resolution failure and produce placeholder stubs.
- The interactive mode (readline REPL) creates a fresh Commander program for every command. Slightly wasteful but not a problem at current scale.
- **Dashboard Phase 5 pending**: Accessibility audit, responsive layout (sidebar collapse), i18n token extraction from hardcoded strings, bundle size audit (~80KB gzipped, acceptable).
