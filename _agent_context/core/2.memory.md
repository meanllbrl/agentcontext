---
name: active-memory
type: memory
updated: "2026-02-26"
---

## Active Memory


<!-- LIFO: newest entries at top -->

### 2026-02-26 - SQL Parser Rewrite + SubagentStart Briefing Restructure

Rewrote `dashboard/src/lib/sql-parser.ts` from comma-split to line-by-line parsing. Fixes broken field extraction for multi-line CREATE TABLE statements. Added: REFERENCES detection for FK relationships, JSONB sub-field parsing from inline comments (e.g. `-- json: field_name: description`), `isSqlType()` validation helper.

Updated `dashboard/src/components/core/SqlPreview.tsx` and `SqlPreview.css`: collapsible JSONB field groups with toggle arrows and count badges, nested field display with left border and dot-notation names, new type color categories (number, json, timestamp).

Restructured `generateSubagentBriefing()` in `src/cli/commands/snapshot.ts`: hard directive ("BEFORE searching or exploring code, read `_agent_context/` files") moved to top of briefing, Features section promoted to position 3 with direct file Read paths for each feature, verbose system structure explanation replaced with compact 3-line Context Directory section at bottom. Problem solved: sub-agents were ignoring context and doing expensive codebase searches. 3 integration tests updated. 325 tests passing.

### 2026-02-26 - Enhanced Kanban Task Filters

Enhanced TaskFilters component with status filter dropdown, text search (name + description), and date range filter with field selector (created_at/updated_at). All filter state now persisted to localStorage via new `usePersistedState` hook (`dashboard/src/hooks/usePersistedState.ts`, prefix: `agentcontext:`). Clear Filters button shows active-count badge and resets filter fields only (preserves sortField and groupBy). `applyFilters()` in KanbanBoard.tsx handles all filter logic; `FilterState` interface exported from TaskFilters.tsx.

### 2026-02-26 - Dashboard UI Polish + selectedTask Bug Fix

Fixed stale snapshot bug in KanbanBoard: replaced `selectedTask: Task | null` state with `selectedSlug: string | null` + `useMemo` derivation from live query data. Detail panel now reflects post-mutation state without a manual refetch. 325 tests passing.

UI polish session: animated radial brand gradient on body (subtle-pulse 20s), stagger entrance animations for Kanban columns (`animate-stagger-N` classes, `slide-up-fade` with spring cubic-bezier), CSS refinements across all major components (Header, Sidebar, TaskCard, TaskCreateModal, TaskDetailPanel, CorePage, FeaturesPage, SleepPage, tokens). No structural changes.

### 2026-02-26 - Release Discovery System

Built `src/lib/release-discovery.ts`: auto-discovers unreleased tasks (status != completed or no released_version), features (released_version is null), and changelog entries (since last release date). `src/lib/release-backpopulate.ts` stamps `released_version` on features when bundled into a release.

CLI: `releases add --yes` (non-interactive, includes all unreleased), `releases list`, `releases show <version>`. Interactive `releases add` uses checkbox prompts. 3 new API routes added to server. Snapshot now shows Latest Release section; changelog limit dropped from 5 to 3 per request.

Release entry schema: `{ id, version, date, summary, breaking, features[], tasks[], changelog[] }`.

13 unit tests + 10 integration tests added; 325 total passing.

### 2026-02-26 - README + DEEP-DIVE Documentation Update

Updated README.md: Dashboard nav link, interactive mode mention in Quick Start, expanded Mermaid lifecycle diagram, full Dashboard section (usage, 2x2 feature table, design notes), releases commands (`add --yes`, `list`, `show`), Dashboard command subsection, auto-discovery explanation, "Web Dashboard" in Works With.

Updated DEEP-DIVE.md: features/ row in brain-region table, updated hook flow diagram with dashboard changes + latest release, full Dashboard section (change tracking, technical decisions, release management), 6 new Design Tradeoffs rows, "What Comes Next" reflects dashboard shipped.

### 2026-02-25 - SubagentStart Briefing Enrichment

Expanded SubagentStart hook briefing content. The briefing sub-agents receive now includes: system structure explanation (soul/user/memory/extended/features purpose), extended core files index, features listing (name, status, why, related tasks), knowledge index, and priority instructions ("Check feature PRDs first"). 4 new integration tests added; 301 tests passing.

### 2026-02-25 - SQL ER Diagram Preview (Dashboard)

Added visual ER diagram tab to `5.data_structures.sql` in the core file viewer.

New files: `dashboard/src/lib/sql-parser.ts` (parses CREATE TABLE and comment-based schema; extracts entities, fields with type inference, FK relationships), `dashboard/src/components/core/SqlPreview.tsx` (entity cards in CSS grid, SVG bezier curves with arrowheads for relationships), `dashboard/src/components/core/SqlPreview.css` (dot-grid background, storage type badges, color-coded field types, enum pills, PK/FK indicators).

Modified: `CorePage.tsx` now shows File/Preview tab toggle for SQL files, Preview is default. Tab bar uses segmented button design with brand gradient on active tab.

### 2026-02-25 - Change Tracker Field-Level Diffs

Enhanced `src/server/change-tracker.ts` with `FieldChange` interface (`from`/`to` values). `DashboardChange` now has an optional `fields` array. Net-change detection: A->B then B->A = cancelled (entry removed); A->B then B->C = folded to A->C. Append-only actions (changelog, insert) bypass detection.

Routes updated: `tasks.ts` reads old frontmatter before mutation, builds `FieldChange[]`; `knowledge.ts` captures old pinned value; `core.ts` detects frontmatter vs content changes; `sleep.ts` captures old debt value.

`FieldChange` interface synced between `src/server/change-tracker.ts`, `src/cli/commands/sleep.ts`, and `dashboard/src/hooks/useSleep.ts`. 19 new unit tests in `tests/unit/change-tracker.test.ts`.

### 2026-02-25 - Dashboard Error Handling & Loading States

Added comprehensive error handling across the dashboard (274 tests passing):
- `dashboard/src/api/client.ts`: `res.ok` check before `res.json()`, try/catch on error parsing
- `dashboard/src/App.tsx`: `ErrorBoundary` class component, query retry config (1 retry for queries, 0 for mutations)
- All 5 pages: `isError` check added
- `TaskDetailPanel.tsx`: mutation error feedback with auto-dismiss after 5s, `isPending` disables buttons
- `src/server/middleware.ts`: 1MB `MAX_BODY_SIZE` limit with `req.destroy()` on overflow
- `src/server/index.ts`: graceful shutdown on SIGINT/SIGTERM, 30s socket timeout, 5s force-exit
- `src/server/static.ts`: `Content-Type: text/plain` on 403/404 responses

### 2026-02-25 - Sleep Race Condition Fix + Tasks Non-Interactive

**Sleep race fix**: `sleep done` was unconditionally clearing all sessions and dashboard_changes, losing records from parallel sessions that finished during consolidation. Fixed with epoch-based filtering: `sleep_started_at` timestamp added to SleepState, new `sleep start` command records epoch, `sleep done` only clears records from before the epoch. Backward compatible when `sleep start` is not called.

**Tasks create non-interactive**: `tasks create` previously launched interactive prompts when `--description` or `--priority` were missing, blocking agent use. Fixed by using task name as default description and `medium` as default priority. Added `--status` flag (todo/in_progress/completed) and `--tags` flag. 279 tests passing.

### 2026-02-25 - Interactive Mode Highlight Fix

Fixed inquirer highlight styling bug where the full menu line was being colored instead of just the item name. Root cause: `style.highlight` in inquirer receives `'  ' + name` (cursor + space prefix), not just the name. Map key lookup was failing silently because keys stored only the name. Fix: `text.slice(2)` strips the 2-char cursor prefix before lookup, wraps result with `'  '` + `chalk.bgHex('#581C87')` background fill.

Result: unfocused items show dim border + category-colored label; focused items show bright magenta border + white bold label + purple `#581C87` background fill.

### 2026-02-25 - Web Dashboard (Phase 1-4)

Built `agentcontext dashboard` command: a local HTTP server serving a React SPA for visual context management.

**Server** (`src/server/`): Node.js native `http` module, zero new runtime deps. Router with `:param` extraction. Middleware for JSON parsing, CORS. Static file serving from `dist/dashboard/`. 17 REST API endpoints across 7 route files (tasks, sleep, core, knowledge, features, changelog, health). Change tracker records every mutating API call to `.sleep.json dashboard_changes`.

**React app** (`dashboard/`): React 19 + Vite 6, TypeScript strict. TanStack Query for server state. Pages: Kanban board (drag-drop, filter, sort, group), sleep state, core file editor, knowledge manager, features viewer. Design system: purple-magenta brand tokens (#641787, #781ca3, #8200a6, #db04b4), Visby CF font, 4px grid, HSL colors, light/dark mode, i18n-ready (English only, t() with translation keys).

**SleepState** extended: `dashboard_changes: DashboardChange[]` records entity/action/target/summary per manual user change. Cleared on `agentcontext sleep done`.

**Build**: `npm run build` = `build:dashboard` (Vite) + `build:cli` (tsup). tsup `onSuccess` copies `dashboard/dist/` to `dist/dashboard/`. Both ship in the npm package.

**Tests**: 325 passing (after subsequent sessions). Phase 5 remaining: accessibility audit, responsive polish, bundle size audit. Loading/error states completed (Phase 4).

Key decisions:
- React + Vite over Preact/Svelte for full ecosystem (TanStack Query, component patterns).
- Native HTML drag-and-drop over @dnd-kit. Upgrade if UX insufficient.
- No router library. State-based 5-page switcher. Add wouter later if URL routing needed.
- No CSS framework. Custom CSS with design tokens. Full control, minimal bundle.
- `dashboard/` is a separate package with its own `package.json`. Keeps React deps out of CLI deps.
- Agent character placeholder: brand diamond logo with opacity/animation tied to sleep level. Custom design coming later.

### 2026-02-25 - SubagentStart Hook + Code Registry Removal + Features Snapshot

SubagentStart hook: `hook subagent-start` outputs JSON briefing (~25 lines) for all sub-agents via `generateSubagentBriefing()`. Lighter than snapshot: project summary, directory structure, active tasks, knowledge index, pinned knowledge. No soul/user/memory (avoids leaking agent rules). No matcher: fires for all sub-agents. `install-skill` registers all three hooks. 246 tests.

Code registry removed: static registries go stale when methods move. Grep/Glob serve discovery better. Slot 6 intentionally open for user customization. 9 commands total.

Features snapshot: each feature now shows Why snippet (120 char cap), related_tasks, and latest non-creation changelog entry. Uses `readSection` from `src/lib/markdown.ts`. 225 tests passing. All 5 functional gaps confirmed resolved.

### 2026-02-25 - Hook-Based Sleep Debt Auto-Tracking + Smart Snapshot + Sleep State

- `hook stop` / `hook session-start` implemented. Stop hook records session to .sleep.json (synchronous stdin read). SessionStart analyzes previous transcript (regex for Write/Edit tool calls), auto-scores debt (1-3=+1, 4-8=+2, 9+=+3), injects graduated consolidation directives, then outputs snapshot. `install-skill` migrates existing hooks.
- Smart Snapshot: extended core files index (`core-index.ts`), knowledge index (`knowledge-index.ts`), pinned knowledge (full content loaded for `pinned: true` files). `knowledge index` and `knowledge tags` commands added.
- Persistent sleep state: `sleep status/add/done/debt` in `state/.sleep.json`.
- CLI stripped: removed list/read/search/update subcommands (was 203 tests, now 162 after strip).
- README rewritten: token-burning search spiral framing, Mermaid lifecycle diagram, brain-region analogy table, no em dashes. PRD.md deleted; key content preserved in `knowledge/project-origin-and-prd.md`.

### 2026-02-24 - Context Populated
Full codebase scan. All commands implemented, unit and integration tests written. SKILL.md, initializer agent, and rem-sleep agent complete and shipping with package.

## Technical Decisions

- **selectedSlug over selectedTask in KanbanBoard**: Store slug string in state, derive Task via useMemo from live query. Prevents stale snapshots after mutations without additional refetch logic.
- **Release discovery is built-in, not deferred**: `releases add --yes` auto-discovers all unreleased items and back-populates features. The richer schema (features[], tasks[], changelog[]) shipped in the same session as discovery.
- **FieldChange net-change detection**: Change tracker folds A->B->C into A->C and cancels A->B->A. Append-only actions and entries without a `fields` array bypass detection.
- **SQL ER diagram uses SVG bezier curves, not a graph library**: D3/React Flow overkill. SVG paths with cubic bezier + arrowheads over CSS grid entity layout.
- **sql-parser.ts uses line-by-line parsing, not comma-split**: Comma-split breaks on multi-line column definitions and inline comments. Line-by-line tracks context (inside table, current field) and handles REFERENCES, JSONB comment annotations, and isSqlType validation without regex soup.
- **SubagentStart hook outputs JSON, SessionStart outputs plain text**: Driven by Claude Code's hook specs, not a design choice. Do not conflate these formats.
- **SubagentStart briefing is lighter than snapshot**: Sub-agents are task-focused and short-lived. Excludes soul/user/memory to avoid leaking internal agent rules. Directive ("BEFORE searching code, read _agent_context/ files") placed at the very top; features section at position 3 with direct Read paths. Bottom-loading context was being ignored by sub-agents.
- **Stop hook is synchronous**: Uses `readFileSync(0, 'utf-8')`. Guarantees .sleep.json is written before the next SessionStart hook fires. Async would create a race condition.
- **Sleep epoch-based clearing**: `sleep start` records a timestamp; `sleep done` only clears records from before the epoch. Post-epoch records survive for the next consolidation cycle.
- **Snapshot: no token budget, no truncation**: More tokens beats forgetting. If context grows too large, fix with better organization (pinning, knowledge extraction), not truncation.
- **ESM-only, no bundled deps**: chalk v5+ and nanoid v5+ are ESM-only. tsup externalizes all runtime deps to avoid ESM/CJS dual-package hazards.
- **Keyword search, not semantic**: `src/lib/search.ts` tokenize + substring match with score weighting. Zero dependencies, adequate for the use case.
- **LIFO default in insertToJsonArray**: `position: 'top'` is the default. CHANGELOG.json and task changelogs depend on this â€” do not change without auditing all callers.
- **Snapshot is chalk-free**: Consumed by the SessionStart shell hook. ANSI codes break shell hook processing.

## Known Issues

- **2 pre-existing flaky tests**: `tests/unit/id.test.ts` (`generates 8-char suffix after prefix`, nanoid(8) intermittently returns 5 chars) and a snapshot changelog integration test. 325 tests pass otherwise. Fix nanoid usage or mock before v0.1.0 publish.
- Integration tests require a manual `npm run build` before they can run against `dist/index.js`. `npm run build` builds dashboard first, then CLI.
- `getTemplateDir()` in `init.ts` uses a candidate-path approach. Unusual pnpm node_modules layouts could cause silent template resolution failure and produce placeholder stubs.
- The interactive mode (readline REPL) creates a fresh Commander program for every command. Slightly wasteful but not a problem at current scale.
- **Dashboard Phase 5 pending**: Accessibility audit, responsive layout (sidebar collapse), i18n token extraction from hardcoded strings, bundle size audit (~80KB gzipped, acceptable).
