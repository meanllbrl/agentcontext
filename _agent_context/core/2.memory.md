---
name: active-memory
type: memory
updated: "2026-02-28"
---

## Active Memory


<!-- LIFO: newest entries at top -->

### 2026-02-28 - SleepHistoryEntry: consolidated_at + session_ids; transcript distill timestamp filter

Two improvements to the sleep consolidation infrastructure:

**SleepHistoryEntry fields added**: `consolidated_at: string` (ISO timestamp of when sleep was run) and `session_ids: string[]` (IDs of all sessions processed in that cycle). `sleep done` now collects session IDs from the pre-epoch sessions before clearing them and writes both new fields to the history entry. Backward compatible — old entries without these fields are valid.

**transcript distill timestamp filter**: `distillTranscript()` now accepts an optional `sinceTimestamp` parameter. Default behavior auto-detects from sleep history: if the session was previously consolidated, the command only shows content after `consolidated_at` for that session. Prevents the sleep agent from re-reading already-processed content when a session spans multiple consolidation cycles. `--full` flag overrides to show the entire transcript. `--since <iso-timestamp>` allows manual cutoff. Entries without a `timestamp` field pass through (can't be compared). 7 new tests added (394 total, all passing).

### 2026-02-28 - transcript distill: full diffs, thinking blocks, trivial responses, subagent I/O

Iterative improvements to `transcript distill` output quality based on user feedback:

- **Full content, no truncation**: Tool input and output shown in full; user decides what's signal vs noise.
- **Thinking blocks included**: `[thinking]` blocks captured from assistant messages (previously filtered as noise).
- **Trivial responses included**: Short agent responses kept (>20 char filter removed for assistant text blocks).
- **Subagent I/O**: `[subagent-task]` input and `[subagent-result]` output shown; internal tool calls within sub-agents remain filtered.
- **Code change deltas**: Edit/Write changes now show byte delta (`[+285B]`, `[-86B]`) and Write shows line count, not just the file path — context without full diff noise.
- **Modifying bash filter preserved**: Non-modifying shell commands (read-only `ls`, `cat`, etc.) still filtered; git/npm/rm etc. shown.

Commit: `443b944`. 387 tests at that point (394 now with subsequent session_ids work).

### 2026-02-27 - SubagentStart Hook Context Propagation Fix

Root cause analysis: `additionalContext` from SubagentStart hooks is inherently lower priority than the sub-agent's built-in system prompt. We cannot change Claude Code's internal prioritization — the real fix is making the main agent (Opus, full context) smarter about delegation, not relying on the sub-agent (possibly Haiku, lower-priority injection) following secondary instructions.

**SKILL.md fix (highest impact)**: Replaced the "Context Propagation" paragraph in the Sub-Agents section. The old text said "You do not need to repeat context when delegating to sub-agents" — this was actively harmful. New text explicitly instructs the main agent to match user request keywords against feature tags/names from the snapshot and include specific `_agent_context/` file paths in Explore/Plan prompts with examples.

**SubagentStart briefing strengthened** (`src/cli/commands/snapshot.ts`): Directive changed from "IMPORTANT" to "MANDATORY", named specific tools (Glob, Grep), added actionable decision rule ("If any feature name or tag matches your task, Read that feature file first"). Feature format cleaned up: tags on own line, status removed to keep read path prominent.

3 integration tests updated. 386 tests passing.

### 2026-02-27 - Dashboard: Project-Scoped localStorage + Zoom Controls + sleep_history Extraction

**Project-scoped localStorage**: `ProjectContext` fetches `/api/health` on mount to derive a hash-based `projectId`. `usePersistedState` keys scoped as `agentcontext:{projectId}:{key}` so different projects on the same port get isolated filter/preset state. Theme stays global. Legacy keys auto-migrated on first load.

**Zoom controls**: Font-size tokens in `tokens.css` use `calc(Npx * var(--zoom, 1))`. Header has `-`/`+` buttons with 5 levels (85%, 90%, 100%, 110%, 120%). Zoom persists in localStorage (global) and applies before React hydrates (inline script in `index.html`) to prevent flash.

**Sleep history extraction**: `sleep_history` extracted from `SleepState` to `_agent_context/state/.sleep-history.json` (separate file, read with `readJsonArray`/`writeJsonArray`). Auto-migration: if `.sleep.json` still contains `sleep_history`, `readSleepState()` moves it and strips the old key. Updated `snapshot.ts`, `sleep done`, `sleep history` subcommand, `6.system_flow.md`, and 4 history tests. 386 tests passing.

### 2026-02-27 - Neuroscience-Inspired Memory System (8 Phases)

Major redesign implementing the two-stage memory selection model from Joo & Frank 2025 (Science). Core innovation: separating waking-phase memory selection (bookmarking) from sleep-phase memory consolidation. Previously the sleep agent processed everything equally; now the agent tags important moments during active work and the sleep agent prioritizes those.

**Phase 1 - Bookmarks (Awake Ripples)**: `bookmark add/list/clear` commands. `Bookmark` type + `bookmarks[]` in `SleepState`. Stop hook links unlinked bookmarks to their session. Critical (salience 3) bookmarks trigger consolidation advisory regardless of debt level.

**Phase 2 - Knowledge Decay**: `knowledge touch <slug>` records access in `knowledge_access{}` map in `SleepState`. Snapshot shows staleness indicators for knowledge files not accessed in 30+ days.

**Phase 3 - Consolidation Rhythm**: `sessions_since_last_sleep` counter in `SleepState`. Rhythm advisory fires at 5+ sessions. Counter resets in `sleep done`.

**Phase 4 - Warm Knowledge Tier**: `extractFirstParagraph()` helper (handles YAML frontmatter). Warm knowledge section appears in snapshot between index and pinned. Warm = recently accessed (7-day window) OR tag-overlap with active tasks.

**Phase 5 - Contextual Triggers**: `trigger add/list/remove` commands. `Trigger` type + `triggers[]` in `SleepState`. Trigger matching in `generateSnapshot()` against task names, tags, bookmark text. `fired_count` persisted by `writeSleepState()` inside snapshot generation. Auto-expiry after `max_fires` hits, cleared in `sleep done`.

**Phase 6 - Transcript Distillation**: `transcript distill <session_id>` command. Pure Node.js structural JSONL filtering. Keeps: user messages, agent text (>20 chars), Write/Edit calls, modifying Bash, bookmark calls, errors. Discards: Read/Glob/Grep results, tool metadata, subagent internals.

**Phase 7 - Sleep History**: `SleepHistoryEntry` type, `sleep_history[]` (LIFO) in `SleepState`. `sleep history` subcommand. `sleep done` writes entry with debt_before/after, sessions and bookmarks processed. Snapshot shows last 3 entries.

**Phase 8 - System Flow Documentation**: Core file `_agent_context/core/6.system_flow.md` created with complete lifecycle, neuroscience mapping, data flows, SleepState schema, and salience levels.

**Cross-cutting fixes**: `freshDefaults()` replaces `DEFAULT_SLEEP_STATE` spread to prevent shared-reference mutation across test runs. Unnecessary `SleepState` casts removed from `change-tracker.ts` and `routes/sleep.ts`. 48 new tests added (384 total, 383 passing, 1 pre-existing flaky nanoid test). SKILL.md updated with bookmarking section and +9 commands. Rem-sleep agent updated with bookmark-first processing and transcript distillation.

New command files: `src/cli/commands/bookmark.ts`, `src/cli/commands/trigger.ts`, `src/cli/commands/transcript.ts`.

### 2026-02-27 - Notion-Style TaskDetailPanel Redesign

Redesigned `dashboard/src/components/tasks/TaskDetailPanel.tsx` from a rigid per-section layout to a Notion-style properties-block + markdown-body layout.

**Server**: Added `body: string` field to `TaskData` interface in `src/server/routes/tasks.ts`. Populated from `content` returned by `readFrontmatter()` (was already available but unused). All existing section fields kept for backward compat with CLI insert endpoints.

**Frontend**: Added `body: string` to `Task` interface in `dashboard/src/hooks/useTasks.ts`. Added `marked@^15` to `dashboard/package.json` for markdown-to-HTML rendering (~14KB gzipped, zero transitive deps).

**TaskDetailPanel**: Properties block (Notion-style bordered card, 140px label / 1fr value grid). Status and priority remain interactive dropdowns. Tags, feature, description, dates, and ID shown as property rows. Description uses ExpandableText (3-line clamp, requestAnimationFrame + scrollHeight > clientHeight detection). Full markdown body rendered below via `marked.parse()` + `dangerouslySetInnerHTML`. Changelog add form at bottom. Removed: TASK_SECTIONS array, per-section `<pre>` blocks, all "Add to X..." inputs, useInsertTaskSection import.

**CSS**: Panel widened from 520px to 680px. New `.props-block` / `.prop-row` classes. Comprehensive `.markdown-body` typography (h1-h6, lists, tables, code blocks, blockquotes, links, task checkboxes). Old section-specific classes removed.

Decision: `marked` over `react-markdown` — lighter (no transitive deps), HTML string output safe since content is local files only.

### 2026-02-27 - Tool Count Debt Scoring

Added `tool_count` field to `SessionRecord` to fix under-scoring of sessions that do significant work via read-only tools (Bash, Read, Glob, Grep) without any Write/Edit calls.

`scoreFromToolCount()` in `src/cli/commands/hook.ts`: 0 tools → 0, 1-15 → +1, 16-40 → +2, 41+ → +3. Final session score is `Math.max(scoreFromChangeCount, scoreFromToolCount)`. Stop hook records `tool_count` (all tool calls) alongside `change_count`. Snapshot display format updated: `(+2) 0 changes, 35 tools`. Dashboard types (`useSleep.ts`, `SleepPage.tsx`) updated to show `tool_count`. 8 new unit tests + 2 new integration tests added. 336 tests passing total.

### 2026-02-26 - SQL Parser Rewrite + SubagentStart Briefing Restructure

Rewrote `dashboard/src/lib/sql-parser.ts` from comma-split to line-by-line parsing. Fixes broken field extraction for multi-line CREATE TABLE statements. Added: REFERENCES detection for FK relationships, JSONB sub-field parsing from inline comments (e.g. `-- json: field_name: description`), `isSqlType()` validation helper.

Updated `dashboard/src/components/core/SqlPreview.tsx` and `SqlPreview.css`: collapsible JSONB field groups with toggle arrows and count badges, nested field display with left border and dot-notation names, new type color categories (number, json, timestamp).

Restructured `generateSubagentBriefing()` in `src/cli/commands/snapshot.ts`: hard directive ("BEFORE searching or exploring code, read `_agent_context/` files") moved to top of briefing, Features section promoted to position 3 with direct file Read paths for each feature, verbose system structure explanation replaced with compact 3-line Context Directory section at bottom. Problem solved: sub-agents were ignoring context and doing expensive codebase searches. 3 integration tests updated. 325 tests passing.

### 2026-02-26 - Enhanced Kanban Task Filters

Enhanced TaskFilters component with status filter dropdown, text search (name + description), and date range filter with field selector (created_at/updated_at). All filter state now persisted to localStorage via new `usePersistedState` hook (`dashboard/src/hooks/usePersistedState.ts`, prefix: `agentcontext:`). Clear Filters button shows active-count badge and resets filter fields only (preserves sortField and groupBy). `applyFilters()` in KanbanBoard.tsx handles all filter logic; `FilterState` interface exported from TaskFilters.tsx.

### 2026-02-26 - Dashboard UI Polish + selectedTask Bug Fix

Fixed stale snapshot bug in KanbanBoard: replaced `selectedTask: Task | null` state with `selectedSlug: string | null` + `useMemo` derivation from live query data. Detail panel now reflects post-mutation state without a manual refetch. 325 tests passing.

UI polish session: animated radial brand gradient on body (subtle-pulse 20s), stagger entrance animations for Kanban columns (`animate-stagger-N` classes, `slide-up-fade` with spring cubic-bezier), CSS refinements across all major components (Header, Sidebar, TaskCard, TaskCreateModal, TaskDetailPanel, CorePage, FeaturesPage, SleepPage, tokens). No structural changes.

### 2026-02-26 - Release Discovery System

Built `src/lib/release-discovery.ts`: auto-discovers unreleased tasks (status != completed or no released_version), features (released_version is null), and changelog entries (since last release date). `src/lib/release-backpopulate.ts` stamps `released_version` on features when bundled into a release.

CLI: `releases add --yes` (non-interactive, includes all unreleased), `releases list`, `releases show <version>`. Interactive `releases add` uses checkbox prompts. 3 new API routes added to server. Snapshot now shows Latest Release section; changelog limit dropped from 5 to 3 per request.

Release entry schema: `{ id, version, date, summary, breaking, features[], tasks[], changelog[] }`.

13 unit tests + 10 integration tests added; 325 total passing.

### 2026-02-26 - README + DEEP-DIVE Documentation Update

Updated README.md: Dashboard nav link, interactive mode mention in Quick Start, expanded Mermaid lifecycle diagram, full Dashboard section (usage, 2x2 feature table, design notes), releases commands (`add --yes`, `list`, `show`), Dashboard command subsection, auto-discovery explanation, "Web Dashboard" in Works With.

Updated DEEP-DIVE.md: features/ row in brain-region table, updated hook flow diagram with dashboard changes + latest release, full Dashboard section (change tracking, technical decisions, release management), 6 new Design Tradeoffs rows, "What Comes Next" reflects dashboard shipped.

### 2026-02-25 - SubagentStart Briefing Enrichment

Expanded SubagentStart hook briefing content. The briefing sub-agents receive now includes: system structure explanation (soul/user/memory/extended/features purpose), extended core files index, features listing (name, status, why, related tasks), knowledge index, and priority instructions ("Check feature PRDs first"). 4 new integration tests added; 301 tests passing.

### 2026-02-25 - SQL ER Diagram Preview (Dashboard)

Added visual ER diagram tab to `5.data_structures.sql` in the core file viewer.

New files: `dashboard/src/lib/sql-parser.ts` (parses CREATE TABLE and comment-based schema; extracts entities, fields with type inference, FK relationships), `dashboard/src/components/core/SqlPreview.tsx` (entity cards in CSS grid, SVG bezier curves with arrowheads for relationships), `dashboard/src/components/core/SqlPreview.css` (dot-grid background, storage type badges, color-coded field types, enum pills, PK/FK indicators).

Modified: `CorePage.tsx` now shows File/Preview tab toggle for SQL files, Preview is default. Tab bar uses segmented button design with brand gradient on active tab.

### 2026-02-25 - Change Tracker Field-Level Diffs

Enhanced `src/server/change-tracker.ts` with `FieldChange` interface (`from`/`to` values). `DashboardChange` now has an optional `fields` array. Net-change detection: A->B then B->A = cancelled (entry removed); A->B then B->C = folded to A->C. Append-only actions (changelog, insert) bypass detection.

Routes updated: `tasks.ts` reads old frontmatter before mutation, builds `FieldChange[]`; `knowledge.ts` captures old pinned value; `core.ts` detects frontmatter vs content changes; `sleep.ts` captures old debt value.

`FieldChange` interface synced between `src/server/change-tracker.ts`, `src/cli/commands/sleep.ts`, and `dashboard/src/hooks/useSleep.ts`. 19 new unit tests in `tests/unit/change-tracker.test.ts`.

### 2026-02-25 - Web Dashboard (Phase 1-4) + Sleep/Task Fixes

Dashboard built: Node.js native HTTP server, 17 REST API endpoints, React 19 + Vite 6 SPA. Pages: Kanban board (drag-drop, filters, sort, group), sleep state, core file editor, knowledge manager, features viewer. Design: purple-magenta brand tokens, Visby CF font, light/dark mode, i18n-ready. Build pipeline: `build:dashboard` (Vite) + `build:cli` (tsup), both ship in npm. Phase 5 remaining: a11y audit, responsive layout, i18n token extraction, bundle audit.

Other fixes in same period: sleep epoch-based clearing (sleep start records epoch, sleep done only clears pre-epoch records), tasks create non-interactive (`--status`, `--tags` flags, defaults for missing args), interactive mode highlight fix (text.slice(2) strips cursor prefix before Map key lookup), comprehensive dashboard error handling (ErrorBoundary, res.ok checks, 1MB body limit, graceful shutdown).

## Technical Decisions

- **transcript distill auto-filters by consolidated_at**: When a session has already been through a consolidation cycle, `transcript distill` defaults to showing only content after `consolidated_at` from sleep history. This prevents redundant processing. `--full` overrides. Entries without timestamps always pass through.
- **SleepHistoryEntry stores session_ids for distill filtering**: `session_ids: string[]` in each history entry enables `transcript distill` to find the relevant `consolidated_at` timestamp for auto-filtering without scanning all sessions.
- **additionalContext is lower priority than sub-agent system prompt**: Claude Code injects SubagentStart `additionalContext` at lower priority than the sub-agent's own system prompt. We cannot change this prioritization. The correct fix is making the main agent (Opus, full context) smarter about delegation — explicitly including `_agent_context/` file paths in Explore/Plan prompts. The SKILL.md Sub-Agents section now instructs this directly.
- **freshDefaults() prevents shared-reference mutation**: `DEFAULT_SLEEP_STATE` spread shared array references (bookmarks, triggers, etc.) across calls, causing test pollution. `freshDefaults()` in `sleep.ts` constructs a fresh object each time. Always use it when initializing an empty SleepState.
- **Bookmarks as primary consolidation signal**: Separating waking-phase memory selection (bookmarking) from sleep-phase consolidation is the key neuroscience insight. The sleep agent processes critical (salience 3) bookmarks first, then processes by change count. This mirrors the Joo & Frank 2025 hippocampal model.
- **Trigger fired_count persisted inside generateSnapshot()**: `writeSleepState()` is called within `generateSnapshot()` after matching triggers so fired counts survive without a separate persist step. Triggers expire in `sleep done`.
- **Transcript distillation is structural, not semantic**: Pure Node.js JSONL line filter. No AI call needed to reduce a 50K-line transcript to 200 high-signal lines. Tool name pattern matching is sufficient.
- **Warm knowledge uses 7-day window + tag overlap**: Two signals determine "warm": accessed in the last 7 days (from knowledge_access map) OR tag overlap with currently active tasks. First paragraph only (handles YAML frontmatter). Pinned knowledge remains separate (full content).
- **System flow lives in core/6, not knowledge/**: The lifecycle document is a core reference that the main agent should always be able to find from the snapshot. Knowledge files are for deep research on specific topics.
- **marked over react-markdown for task body rendering**: `marked@^15` is ~14KB gzipped with zero transitive deps. Safe to use `dangerouslySetInnerHTML` because content is local files only, never user-supplied remote content.
- **tool_count scoring uses Math.max over scoreFromChangeCount**: Bash-heavy sessions with no file writes previously scored 0. `scoreFromToolCount` (0/1-15/16-40/41+ → 0/1/2/3) provides a floor without double-counting work that involves both reads and writes.
- **selectedSlug over selectedTask in KanbanBoard**: Store slug string in state, derive Task via useMemo from live query. Prevents stale snapshots after mutations without additional refetch logic.
- **Release discovery is built-in, not deferred**: `releases add --yes` auto-discovers all unreleased items and back-populates features. The richer schema (features[], tasks[], changelog[]) shipped in the same session as discovery.
- **FieldChange net-change detection**: Change tracker folds A->B->C into A->C and cancels A->B->A. Append-only actions and entries without a `fields` array bypass detection.
- **SQL ER diagram uses SVG bezier curves, not a graph library**: D3/React Flow overkill. SVG paths with cubic bezier + arrowheads over CSS grid entity layout.
- **sql-parser.ts uses line-by-line parsing, not comma-split**: Comma-split breaks on multi-line column definitions and inline comments. Line-by-line tracks context (inside table, current field) and handles REFERENCES, JSONB comment annotations, and isSqlType validation without regex soup.
- **SubagentStart hook outputs JSON, SessionStart outputs plain text**: Driven by Claude Code's hook specs, not a design choice. Do not conflate these formats.
- **SubagentStart briefing is lighter than snapshot**: Sub-agents are task-focused and short-lived. Excludes soul/user/memory to avoid leaking internal agent rules. Directive ("BEFORE searching code, read _agent_context/ files") placed at the very top; features section at position 3 with direct Read paths. Bottom-loading context was being ignored by sub-agents.
- **Stop hook is synchronous**: Uses `readFileSync(0, 'utf-8')`. Guarantees .sleep.json is written before the next SessionStart hook fires. Async would create a race condition.
- **Sleep epoch-based clearing**: `sleep start` records a timestamp; `sleep done` only clears records from before the epoch. Post-epoch records survive for the next consolidation cycle.
- **Snapshot: no token budget, no truncation**: More tokens beats forgetting. If context grows too large, fix with better organization (pinning, knowledge extraction), not truncation.
- **ESM-only, no bundled deps**: chalk v5+ and nanoid v5+ are ESM-only. tsup externalizes all runtime deps to avoid ESM/CJS dual-package hazards.
- **Keyword search, not semantic**: `src/lib/search.ts` tokenize + substring match with score weighting. Zero dependencies, adequate for the use case.
- **LIFO default in insertToJsonArray**: `position: 'top'` is the default. CHANGELOG.json and task changelogs depend on this — do not change without auditing all callers.
- **Snapshot is chalk-free**: Consumed by the SessionStart shell hook. ANSI codes break shell hook processing.

## Known Issues

- **1 pre-existing flaky test**: `tests/unit/id.test.ts` (`generates 8-char suffix after prefix`, nanoid(8) intermittently returns 5 chars). 394 tests total now all passing in CI runs, but the flaky test may still intermittently fail. Fix nanoid usage or mock before next publish.
- Integration tests require a manual `npm run build` before they can run against `dist/index.js`. `npm run build` builds dashboard first, then CLI.
- `getTemplateDir()` in `init.ts` uses a candidate-path approach. Unusual pnpm node_modules layouts could cause silent template resolution failure and produce placeholder stubs.
- The interactive mode (readline REPL) creates a fresh Commander program for every command. Slightly wasteful but not a problem at current scale.
- **Dashboard Phase 5 pending**: Accessibility audit, responsive layout (sidebar collapse), i18n token extraction from hardcoded strings, bundle size audit (~80KB gzipped, acceptable).
